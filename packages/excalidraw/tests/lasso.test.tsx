/**
 * Test case:
 *
 * create a few random elements on canvas
 * creates a lasso path for each of these cases
 * - do not intersect / enclose at all
 * - intersects some, does not enclose/intersect the rest
 * - intersects and encloses some
 * - single linear element should be selected if lasso intersects/encloses it
 *
 *
 * special cases:
 * - selects only frame if frame and children both selected by lasso
 * - selects group if any group from group is selected
 */

import {
  type GlobalPoint,
  type LocalPoint,
  pointFrom,
  type Radians,
  type ElementsSegmentsMap,
} from "@excalidraw/math";

import { getElementLineSegments } from "@excalidraw/element";

import type { ExcalidrawElement } from "@excalidraw/element/types";

import { Excalidraw } from "../index";

import { getSelectedElements } from "../scene";

import { getLassoSelectedElementIds } from "../lasso/utils";

import { act, render } from "./test-utils";

const { h } = globalThis;

beforeEach(async () => {
  localStorage.clear();
  await render(<Excalidraw handleKeyboardGlobally={true} />);
  h.state.width = 1000;
  h.state.height = 1000;
});

const updatePath = (startPoint: GlobalPoint, points: LocalPoint[]) => {
  act(() => {
    h.app.lassoTrail.startPath(startPoint[0], startPoint[1]);

    for (const point of points) {
      h.app.lassoTrail.addPointToPath(
        startPoint[0] + point[0],
        startPoint[1] + point[1],
      );
    }

    const elementsSegments: ElementsSegmentsMap = new Map();
    for (const element of h.elements) {
      const segments = getElementLineSegments(
        element,
        h.app.scene.getElementsMapIncludingDeleted(),
      );
      elementsSegments.set(element.id, segments);
    }

    const result = getLassoSelectedElementIds({
      lassoPath:
        h.app.lassoTrail
          .getCurrentTrail()
          ?.originalPoints?.map((p) => pointFrom<GlobalPoint>(p[0], p[1])) ??
        [],
      elements: h.elements,
      elementsMap: h.scene.getNonDeletedElementsMap(),
      elementsSegments,
      intersectedElements: new Set(),
      enclosedElements: new Set(),
    });

    act(() =>
      h.app.lassoTrail.selectElementsFromIds(result.selectedElementIds),
    );

    h.app.lassoTrail.endPath();
  });
};

describe("Basic lasso selection tests", () => {
  beforeEach(() => {
    const elements: ExcalidrawElement[] = [
      {
        id: "FLZN67ISZbMV-RH8SzS9W",
        type: "rectangle",
        x: 0,
        y: 0,
        width: 107.113_281_25,
        height: 90.160_156_25,
        angle: 5.402_712_410_723_78,
        strokeColor: "#1e1e1e",
        backgroundColor: "transparent",
        fillStyle: "solid",
        strokeWidth: 2,
        strokeStyle: "solid",
        roughness: 1,
        opacity: 100,
        groupIds: [],
        frameId: null,
        index: "a8",
        roundness: {
          type: 3,
        },
        seed: 1_558_764_732,
        version: 43,
        versionNonce: 575_357_188,
        isDeleted: false,
        boundElements: [],
        updated: 1_740_723_127_946,
        link: null,
        locked: false,
      },
      {
        id: "T3TSAFUwp--pT2b_q7Y5U",
        type: "diamond",
        x: 349.822_265_625,
        y: -201.244_140_625,
        width: 123.382_812_5,
        height: 74.667_968_75,
        angle: 0.649_899_871_721_241_4,
        strokeColor: "#1e1e1e",
        backgroundColor: "transparent",
        fillStyle: "solid",
        strokeWidth: 2,
        strokeStyle: "solid",
        roughness: 1,
        opacity: 100,
        groupIds: [],
        frameId: null,
        index: "a9",
        roundness: {
          type: 2,
        },
        seed: 1_720_937_276,
        version: 69,
        versionNonce: 1_991_578_556,
        isDeleted: false,
        boundElements: [],
        updated: 1_740_723_132_096,
        link: null,
        locked: false,
      },
      {
        id: "a9RZwSeqlZHyhses2iYZ0",
        type: "ellipse",
        x: 188.259_765_625,
        y: -48.193_359_375,
        width: 146.898_437_5,
        height: 91.011_718_75,
        angle: 0.607_065_296_453_206_4,
        strokeColor: "#1e1e1e",
        backgroundColor: "transparent",
        fillStyle: "solid",
        strokeWidth: 2,
        strokeStyle: "solid",
        roughness: 1,
        opacity: 100,
        groupIds: [],
        frameId: null,
        index: "aA",
        roundness: {
          type: 2,
        },
        seed: 476_696_636,
        version: 38,
        versionNonce: 1_903_760_444,
        isDeleted: false,
        boundElements: [],
        updated: 1_740_723_125_079,
        link: null,
        locked: false,
      },
      {
        id: "vCw17KEn9h4sY2KMdnq0G",
        type: "arrow",
        x: -257.388_671_875,
        y: 78.583_984_375,
        width: 168.476_562_5,
        height: 153.386_718_75,
        angle: 0,
        strokeColor: "#1e1e1e",
        backgroundColor: "transparent",
        fillStyle: "solid",
        strokeWidth: 2,
        strokeStyle: "solid",
        roughness: 1,
        opacity: 100,
        groupIds: [],
        frameId: null,
        index: "aB",
        roundness: {
          type: 2,
        },
        seed: 1_302_309_508,
        version: 19,
        versionNonce: 1_230_691_388,
        isDeleted: false,
        boundElements: [],
        updated: 1_740_723_110_578,
        link: null,
        locked: false,
        points: [
          [0, 0],
          [168.476_562_5, -153.386_718_75],
        ],
        startBinding: null,
        endBinding: null,
        startArrowhead: null,
        endArrowhead: "arrow",
        elbowed: false,
      },
      {
        id: "dMsLoKhGsWQXpiKGWZ6Cn",
        type: "line",
        x: -113.748_046_875,
        y: -165.224_609_375,
        width: 206.128_906_25,
        height: 35.414_062_5,
        angle: 0,
        strokeColor: "#1e1e1e",
        backgroundColor: "transparent",
        fillStyle: "solid",
        strokeWidth: 2,
        strokeStyle: "solid",
        roughness: 1,
        opacity: 100,
        groupIds: [],
        frameId: null,
        index: "aC",
        roundness: {
          type: 2,
        },
        seed: 514_585_788,
        version: 18,
        versionNonce: 1_338_507_580,
        isDeleted: false,
        boundElements: [],
        updated: 1_740_723_112_995,
        link: null,
        locked: false,
        points: [
          [0, 0],
          [206.128_906_25, 35.414_062_5],
        ],
        startBinding: null,
        endBinding: null,
        startArrowhead: null,
        endArrowhead: null,
      },
      {
        id: "1GUDjUg8ibE_4qMFtdQiK",
        type: "freedraw",
        x: 384.404_296_875,
        y: 91.580_078_125,
        width: 537.550_781_25,
        height: 288.480_468_75,
        angle: 5.534_222_239_602_228_5,
        strokeColor: "#1e1e1e",
        backgroundColor: "transparent",
        fillStyle: "solid",
        strokeWidth: 2,
        strokeStyle: "solid",
        roughness: 1,
        opacity: 100,
        groupIds: [],
        frameId: null,
        index: "aD",
        roundness: null,
        seed: 103_578_044,
        version: 167,
        versionNonce: 1_117_299_588,
        isDeleted: false,
        boundElements: [],
        updated: 1_740_723_137_180,
        link: null,
        locked: false,
        points: [
          [0, 0],
          [-0.105_468_75, 0],
          [-3.230_468_75, -0.859_375],
          [-18.097_656_25, -4.695_312_5],
          [-54.406_25, -13.765_625],
          [-103.480_468_75, -23.058_593_75],
          [-155.664_062_5, -27.539_062_5],
          [-205.570_312_5, -27.964_843_75],
          [-239, -24.476_562_5],
          [-257.277_343_75, -17.039_062_5],
          [-270.101_562_5, -5.433_593_75],
          [-279.941_406_25, 12.121_093_75],
          [-286.828_125, 36.6875],
          [-291.035_156_25, 65.636_718_75],
          [-292.554_687_5, 94.968_75],
          [-291.820_312_5, 122.1875],
          [-286.140_625, 144.703_125],
          [-274.605_468_75, 160.019_531_25],
          [-257.117_187_5, 170.375],
          [-237.789_062_5, 176.195_312_5],
          [-218.855_468_75, 178.699_218_75],
          [-199.339_843_75, 181.566_406_25],
          [-182.460_937_5, 188.476_562_5],
          [-168.972_656_25, 200.144_531_25],
          [-160.839_843_75, 211.1875],
          [-156.402_343_75, 220.070_312_5],
          [-153.605_468_75, 226.128_906_25],
          [-151.320_312_5, 229.300_781_25],
          [-146.281_25, 231.742_187_5],
          [-136.140_625, 233.308_593_75],
          [-122.195_312_5, 233.800_781_25],
          [-108.660_156_25, 234.238_281_25],
          [-97.023_437_5, 235.054_687_5],
          [-89.617_187_5, 235.742_187_5],
          [-85.843_75, 237.527_343_75],
          [-82.546_875, 240.417_968_75],
          [-79.644_531_25, 243.273_437_5],
          [-75.718_75, 245.996_093_75],
          [-69.734_375, 248.445_312_5],
          [-59.664_062_5, 250.878_906_25],
          [-45.117_187_5, 252.445_312_5],
          [-23.945_312_5, 251.726_562_5],
          [7.417_968_75, 244.054_687_5],
          [48.582_031_25, 223.734_375],
          [93.507_812_5, 192.859_375],
          [135.835_937_5, 153.945_312_5],
          [168.875, 114.015_625],
          [186.5625, 86.640_625],
          [194.976_562_5, 71.191_406_25],
          [199.023_437_5, 62.671_875],
          [199.875, 59.617_187_5],
          [200.179_687_5, 58.722_656_25],
          [200.414_062_5, 58.621_093_75],
          [200.871_093_75, 58.574_218_75],
          [203.179_687_5, 58.273_437_5],
          [208.722_656_25, 55.671_875],
          [216.421_875, 50.894_531_25],
          [224.546_875, 45.265_625],
          [234.406_25, 36.308_593_75],
          [241.714_843_75, 28.144_531_25],
          [243.6875, 24.117_187_5],
          [244.617_187_5, 21.343_75],
          [244.996_093_75, 18.5625],
          [243.785_156_25, 12.410_156_25],
          [237.632_812_5, -4.8125],
          [222.917_968_75, -36.035_156_25],
          [222.917_968_75, -36.035_156_25],
        ],
        pressures: [],
        simulatePressure: true,
      },
    ].map(
      (e) =>
        ({
          ...e,
          angle: e.angle as Radians,
          index: null,
        } as ExcalidrawElement),
    );

    act(() => {
      h.elements = elements;
      h.app.setActiveTool({ type: "lasso" });
    });
  });

  it("None should be selected", () => {
    const startPoint = pointFrom<GlobalPoint>(-533, 611);

    const points = [
      [0, 0],
      [0.101_562_5, -0.097_656_25],
      [10.167_968_75, -8.156_25],
      [25.714_843_75, -18.507_812_5],
      [46.078_125, -28.636_718_75],
      [90.578_125, -41.914_062_5],
      [113.042_968_75, -45.085_937_5],
      [133.957_031_25, -46.289_062_5],
      [152.925_781_25, -46.289_062_5],
      [170.921_875, -44.988_281_25],
      [190.164_062_5, -39.613_281_25],
      [213.730_468_75, -29],
      [238.859_375, -16.593_75],
      [261.878_906_25, -5.800_781_25],
      [281.636_718_75, 2.445_312_5],
      [300.125, 9.019_531_25],
      [320.093_75, 14.046_875],
      [339.140_625, 16.957_031_25],
      [358.320_312_5, 18.417_968_75],
      [377.523_437_5, 17.890_625],
      [396.457_031_25, 14.535_156_25],
      [416.492_187_5, 8.015_625],
      [438.796_875, -1.542_968_75],
      [461.632_812_5, -11.570_312_5],
      [483.363_281_25, -21.488_281_25],
      [503.371_093_75, -30.871_093_75],
      [517.054_687_5, -36.496_093_75],
      [525.621_093_75, -39.664_062_5],
      [531.457_031_25, -41.468_75],
      [534.132_812_5, -41.9375],
      [535.324_218_75, -42.093_75],
      [544.414_062_5, -42.093_75],
      [567.226_562_5, -42.093_75],
      [608.1875, -38.5625],
      [665.203_125, -27.667_968_75],
      [725.898_437_5, -11.300_781_25],
      [785.050_781_25, 8.175_781_25],
      [832.121_093_75, 25.550_781_25],
      [861.621_093_75, 36.324_218_75],
      [881.917_968_75, 42.203_125],
      [896.75, 45.125],
      [907.042_968_75, 46.464_843_75],
      [917.449_218_75, 46.425_781_25],
      [930.671_875, 42.597_656_25],
      [945.953_125, 34.667_968_75],
      [964.089_843_75, 22.433_593_75],
      [989.8125, 2.328_125],
      [1014.664_062_5, -17.792_968_75],
      [1032.773_437_5, -32.707_031_25],
      [1045.984_375, -43.992_187_5],
      [1052.488_281_25, -50.1875],
      [1054.972_656_25, -53.304_687_5],
      [1055.652_343_75, -54.386_718_75],
      [1060.480_468_75, -54.839_843_75],
      [1073.031_25, -55.273_437_5],
      [1095.648_437_5, -54],
      [1125.417_968_75, -49.058_593_75],
      [1155.339_843_75, -41.214_843_75],
      [1182.332_031_25, -33.6875],
      [1204.117_187_5, -27.753_906_25],
      [1220.957_031_25, -23.582_031_25],
      [1235.390_625, -21.066_406_25],
      [1248.078_125, -19.351_562_5],
      [1257.781_25, -18.648_437_5],
      [1265.664_062_5, -19.222_656_25],
      [1271.570_312_5, -20.425_781_25],
      [1276.046_875, -21.984_375],
      [1280.328_125, -25.238_281_25],
      [1284.191_406_25, -29.953_125],
      [1288.222_656_25, -35.8125],
      [1292.871_093_75, -43.214_843_75],
      [1296.679_687_5, -50.449_218_75],
      [1299.382_812_5, -56.402_343_75],
      [1301.488_281_25, -61.082_031_25],
      [1302.894_531_25, -64.75],
      [1303.890_625, -67.378_906_25],
      [1304.417_968_75, -68.953_125],
      [1304.652_343_75, -69.804_687_5],
      [1304.800_781_25, -70.257_812_5],
      [1304.800_781_25, -70.257_812_5],
    ] as LocalPoint[];

    updatePath(startPoint, points);

    const selectedElements = getSelectedElements(h.elements, h.app.state);

    expect(selectedElements.length).toBe(0);
  });

  it("Intersects some, does not enclose/intersect the rest", () => {
    const startPoint = pointFrom<GlobalPoint>(-311, 50);
    const points = [
      [0, 0],
      [0.101_562_5, 0],
      [3.402_343_75, -2.253_906_25],
      [12.253_906_25, -7.843_75],
      [22.714_843_75, -13.894_531_25],
      [39.097_656_25, -22.335_937_5],
      [58.554_687_5, -31.960_937_5],
      [79.917_968_75, -41.218_75],
      [90.531_25, -44.769_531_25],
      [99.921_875, -47.167_968_75],
      [107.464_843_75, -48.640_625],
      [113.925_781_25, -49.656_25],
      [119.574_218_75, -50.195_312_5],
      [124.640_625, -50.195_312_5],
      [129.496_093_75, -50.195_312_5],
      [134.531_25, -50.195_312_5],
      [140.593_75, -50.195_312_5],
      [147.277_343_75, -49.871_093_75],
      [154.324_218_75, -48.453_125],
      [160.933_593_75, -46.039_062_5],
      [166.582_031_25, -42.882_812_5],
      [172.007_812_5, -38.867_187_5],
      [176.753_906_25, -34.101_562_5],
      [180.417_968_75, -29.609_375],
      [183.093_75, -25.039_062_5],
      [185.113_281_25, -19.707_031_25],
      [186.882_812_5, -13.042_968_75],
      [188.515_625, -6.394_531_25],
      [189.851_562_5, -1.042_968_75],
      [190.960_937_5, 4.343_75],
      [191.929_687_5, 9.3125],
      [193.066_406_25, 13.730_468_75],
      [194.218_75, 17.519_531_25],
      [195.324_218_75, 20.839_843_75],
      [196.5625, 23.429_687_5],
      [198.210_937_5, 25.523_437_5],
      [200.042_968_75, 27.386_718_75],
      [202.164_062_5, 28.800_781_25],
      [204.433_593_75, 30.339_843_75],
      [207.105_468_75, 31.710_937_5],
      [210.699_218_75, 33.164_062_5],
      [214.601_562_5, 34.488_281_25],
      [218.539_062_5, 35.183_593_75],
      [222.703_125, 35.718_75],
      [227.160_156_25, 35.988_281_25],
      [232.011_718_75, 35.988_281_25],
      [237.265_625, 35.988_281_25],
      [242.597_656_25, 35.015_625],
      [247.421_875, 33.414_062_5],
      [251.613_281_25, 31.906_25],
      [255.843_75, 30.132_812_5],
      [260.253_906_25, 28.621_093_75],
      [264.441_406_25, 27.417_968_75],
      [268.554_687_5, 26.347_656_25],
      [272.617_187_5, 25.425_781_25],
      [276.722_656_25, 24.378_906_25],
      [281.234_375, 23.140_625],
      [286.699_218_75, 22.046_875],
      [293.585_937_5, 20.824_218_75],
      [300.632_812_5, 19.414_062_5],
      [309.839_843_75, 18.164_062_5],
      [320.281_25, 16.757_812_5],
      [329.468_75, 15.910_156_25],
      [337.453_125, 15.535_156_25],
      [344.515_625, 14.820_312_5],
      [350.457_031_25, 14.445_312_5],
      [354.644_531_25, 14.554_687_5],
      [358.105_468_75, 14.921_875],
      [360.832_031_25, 15.523_437_5],
      [362.796_875, 16.367_187_5],
      [364.132_812_5, 17.433_593_75],
      [365.136_718_75, 18.601_562_5],
      [365.898_437_5, 19.820_312_5],
      [366.714_843_75, 21.300_781_25],
      [368.343_75, 23.597_656_25],
      [370.378_906_25, 26.707_031_25],
      [372.156_25, 30.5],
      [374.160_156_25, 34.390_625],
      [376.218_75, 38.492_187_5],
      [378.191_406_25, 43.921_875],
      [380.414_062_5, 50.316_406_25],
      [382.671_875, 56.289_062_5],
      [384.480_468_75, 61.347_656_25],
      [385.789_062_5, 65.144_531_25],
      [386.539_062_5, 66.988_281_25],
      [386.921_875, 67.605_468_75],
      [387.171_875, 67.808_593_75],
      [388.039_062_5, 68.324_218_75],
      [392.238_281_25, 70.367_187_5],
      [403.597_656_25, 76.429_687_5],
      [419.539_062_5, 85.5],
      [435.507_812_5, 93.824_218_75],
      [451.304_687_5, 101.015_625],
      [465.050_781_25, 107.027_343_75],
      [476.828_125, 111.972_656_25],
      [487.386_718_75, 115.578_125],
      [495.980_468_75, 118.031_25],
      [503.203_125, 120.351_562_5],
      [510.375, 122.382_812_5],
      [517.820_312_5, 124.324_218_75],
      [525.386_718_75, 126.9375],
      [532.976_562_5, 130.128_906_25],
      [539.046_875, 133.222_656_25],
      [543.855_468_75, 136.421_875],
      [549.281_25, 140.843_75],
      [554.410_156_25, 146.042_968_75],
      [558.343_75, 151.492_187_5],
      [561.859_375, 157.093_75],
      [564.734_375, 162.718_75],
      [566.957_031_25, 168.375],
      [568.871_093_75, 174.339_843_75],
      [570.417_968_75, 181.269_531_25],
      [571.746_093_75, 189.378_906_25],
      [572.558_593_75, 197.351_562_5],
      [573.046_875, 204.261_718_75],
      [573.742_187_5, 210.945_312_5],
      [574.386_718_75, 216.917_968_75],
      [574.75, 222.851_562_5],
      [575.070_312_5, 228.785_156_25],
      [575.675_781_25, 234.007_812_5],
      [576.261_718_75, 238.351_562_5],
      [576.847_656_25, 242.644_531_25],
      [577.328_125, 247.531_25],
      [577.648_437_5, 252.566_406_25],
      [577.808_593_75, 257.910_156_25],
      [578.128_906_25, 263.257_812_5],
      [578.449_218_75, 269.1875],
      [578.167_968_75, 275.175_781_25],
      [577.523_437_5, 281.078_125],
      [576.144_531_25, 287.593_75],
      [574.199_218_75, 296.390_625],
      [571.964_843_75, 306.031_25],
      [568.765_625, 315.542_968_75],
      [564.683_593_75, 325.640_625],
      [560.367_187_5, 335.031_25],
      [555.933_593_75, 343.683_593_75],
      [551.566_406_25, 352.035_156_25],
      [547.863_281_25, 359.273_437_5],
      [543.824_218_75, 365.242_187_5],
      [539.910_156_25, 370.007_812_5],
      [537.371_093_75, 372.554_687_5],
      [535.476_562_5, 374.238_281_25],
      [533.378_906_25, 375.585_937_5],
      [531.257_812_5, 376.753_906_25],
      [528.468_75, 378.968_75],
      [524.296_875, 381.835_937_5],
      [519.035_156_25, 385.316_406_25],
      [513.503_906_25, 389.289_062_5],
      [506.433_593_75, 394.550_781_25],
      [497.183_593_75, 401.519_531_25],
      [488.433_593_75, 408.406_25],
      [481.152_343_75, 414.070_312_5],
      [475.644_531_25, 417.757_812_5],
      [471.550_781_25, 420.324_218_75],
      [468.738_281_25, 421.828_125],
      [467.164_062_5, 422.328_125],
      [465.929_687_5, 422.695_312_5],
      [464.710_937_5, 422.917_968_75],
      [463.273_437_5, 423.128_906_25],
      [462.066_406_25, 423.332_031_25],
      [460.886_718_75, 423.332_031_25],
      [459.484_375, 423.332_031_25],
      [458.574_218_75, 423.332_031_25],
      [457.929_687_5, 423.105_468_75],
      [457.152_343_75, 422.796_875],
      [456.398_437_5, 422.5625],
      [455.882_812_5, 422.410_156_25],
      [455.558_593_75, 422.410_156_25],
      [455.453_125, 422.320_312_5],
      [455.445_312_5, 422.066_406_25],
      [455.445_312_5, 422.066_406_25],
    ] as LocalPoint[];

    updatePath(startPoint, points);
    const selectedElements = getSelectedElements(h.elements, h.state);
    expect(selectedElements.length).toBe(3);
    expect(selectedElements.filter((e) => e.type === "arrow").length).toBe(1);
    expect(selectedElements.filter((e) => e.type === "rectangle").length).toBe(
      1,
    );
    expect(selectedElements.filter((e) => e.type === "freedraw").length).toBe(
      1,
    );
  });

  it("Intersects some and encloses some", () => {
    const startPoint = pointFrom<GlobalPoint>(112, -190);
    const points = [
      [0, 0],
      [-0.101_562_5, 0],
      [-6.265_625, 3.093_75],
      [-18.367_187_5, 9.015_625],
      [-28.3125, 13.949_218_75],
      [-38.031_25, 19.0625],
      [-52.578_125, 28.722_656_25],
      [-54.519_531_25, 33.003_906_25],
      [-55.394_531_25, 36.074_218_75],
      [-56.046_875, 39.890_625],
      [-57.066_406_25, 45.273_437_5],
      [-57.761_718_75, 51.226_562_5],
      [-57.761_718_75, 56.167_968_75],
      [-57.761_718_75, 60.968_75],
      [-57.761_718_75, 65.796_875],
      [-57.761_718_75, 70.542_968_75],
      [-57.332_031_25, 75.214_843_75],
      [-56.175_781_25, 79.507_812_5],
      [-54.550_781_25, 83.5625],
      [-51.886_718_75, 88.093_75],
      [-48.722_656_25, 92.468_75],
      [-45.324_218_75, 96.242_187_5],
      [-41.628_906_25, 100.585_937_5],
      [-37.9375, 104.925_781_25],
      [-33.949_218_75, 108.917_968_75],
      [-29.703_125, 113.519_531_25],
      [-24.457_031_25, 118.496_093_75],
      [-18.667_968_75, 123.539_062_5],
      [-12.710_937_5, 128.964_843_75],
      [-6.257_812_5, 133.984_375],
      [0.203_125, 138.507_812_5],
      [7.164_062_5, 143.718_75],
      [16.089_843_75, 149.976_562_5],
      [25.019_531_25, 156.164_062_5],
      [33.820_312_5, 162.25],
      [42.050_781_25, 167.792_968_75],
      [48.753_906_25, 172.464_843_75],
      [55.398_437_5, 177.906_25],
      [61.296_875, 184.128_906_25],
      [66.027_343_75, 191.214_843_75],
      [69.765_625, 198.109_375],
      [73.035_156_25, 204.792_968_75],
      [76.093_75, 212.261_718_75],
      [78.984_375, 219.527_343_75],
      [81.582_031_25, 226.347_656_25],
      [84.164_062_5, 232.304_687_5],
      [86.726_562_5, 237.167_968_75],
      [89.683_593_75, 241.347_656_25],
      [93.839_843_75, 245.128_906_25],
      [100.121_093_75, 249.328_125],
      [107.109_375, 253.656_25],
      [114.082_031_25, 257.894_531_25],
      [122.578_125, 262.316_406_25],
      [130.839_843_75, 266.359_375],
      [138.332_031_25, 269.867_187_5],
      [144.984_375, 272.351_562_5],
      [150.265_625, 274.195_312_5],
      [155.425_781_25, 275.929_687_5],
      [159.132_812_5, 276.738_281_25],
      [161.242_187_5, 276.738_281_25],
      [165.113_281_25, 276.757_812_5],
      [172.546_875, 276.761_718_75],
      [183.144_531_25, 276.761_718_75],
      [194.015_625, 276.761_718_75],
      [204.179_687_5, 276.761_718_75],
      [213.484_375, 276.761_718_75],
      [221.406_25, 276.761_718_75],
      [228.472_656_25, 276.761_718_75],
      [234.402_343_75, 276.675_781_25],
      [240.285_156_25, 275.976_562_5],
      [246.121_093_75, 274.593_75],
      [250.753_906_25, 272.851_562_5],
      [255.046_875, 270.183_593_75],
      [259.632_812_5, 266.605_468_75],
      [264.042_968_75, 262.4375],
      [268.691_406_25, 256.699_218_75],
      [273.253_906_25, 249.9375],
      [277.855_468_75, 243.054_687_5],
      [282.191_406_25, 236.585_937_5],
      [285.246_093_75, 231.484_375],
      [287.394_531_25, 227.1875],
      [289.078_125, 223.781_25],
      [290.328_125, 221.281_25],
      [291.039_062_5, 219.210_937_5],
      [291.406_25, 217.839_843_75],
      [291.546_875, 216.753_906_25],
      [291.546_875, 215.843_75],
      [291.753_906_25, 214.773_437_5],
      [291.960_937_5, 213.152_343_75],
      [291.960_937_5, 211.125],
      [291.960_937_5, 208.695_312_5],
      [291.960_937_5, 205.25],
      [291.960_937_5, 201.445_312_5],
      [291.628_906_25, 197.683_593_75],
      [291.0625, 194.292_968_75],
      [290.648_437_5, 192.218_75],
      [290.253_906_25, 190.820_312_5],
      [289.886_718_75, 189.941_406_25],
      [289.75, 189.531_25],
      [289.75, 189.210_937_5],
      [289.726_562_5, 188.292_968_75],
      [290.093_75, 186.3125],
      [293.042_968_75, 182.468_75],
      [298.671_875, 177.464_843_75],
      [305.457_031_25, 172.136_718_75],
      [312.492_187_5, 167.355_468_75],
      [318.640_625, 163.6875],
      [323.148_437_5, 161.070_312_5],
      [326.484_375, 159.371_093_75],
      [329.804_687_5, 157.394_531_25],
      [332.980_468_75, 155.226_562_5],
      [336.097_656_25, 152.6875],
      [339.144_531_25, 149.640_625],
      [342.378_906_25, 146.507_812_5],
      [345.968_75, 143.031_25],
      [349.460_937_5, 139.246_093_75],
      [353.230_468_75, 134.832_031_25],
      [356.683_593_75, 129.722_656_25],
      [359.488_281_25, 123.914_062_5],
      [362.769_531_25, 116.097_656_25],
      [367.917_968_75, 93.691_406_25],
      [368.238_281_25, 88.554_687_5],
      [368.343_75, 86.289_062_5],
      [369.949_218_75, 80.152_343_75],
      [372.757_812_5, 72.042_968_75],
      [375.703_125, 62.5],
      [378.332_031_25, 52.722_656_25],
      [380.109_375, 44.445_312_5],
      [381.406_25, 37.593_75],
      [382.269_531_25, 31.957_031_25],
      [382.718_75, 26.605_468_75],
      [382.816_406_25, 21.761_718_75],
      [382.816_406_25, 17.843_75],
      [382.558_593_75, 13.960_937_5],
      [382.277_343_75, 9.656_25],
      [381.675_781_25, 5.351_562_5],
      [380.406_25, 1.070_312_5],
      [378.714_843_75, -3.210_937_5],
      [376.480_468_75, -7.527_343_75],
      [373.933_593_75, -11.718_75],
      [370.441_406_25, -16.324_218_75],
      [365.863_281_25, -21.496_093_75],
      [359.949_218_75, -26.835_937_5],
      [353.339_843_75, -32.046_875],
      [345.847_656_25, -37.308_593_75],
      [336.558_593_75, -43.214_843_75],
      [326.347_656_25, -48.585_937_5],
      [315.515_625, -53.152_343_75],
      [305.375, -56.675_781_25],
      [296, -59.472_656_25],
      [286.078_125, -61.984_375],
      [276.078_125, -63.781_25],
      [266.578_125, -65.097_656_25],
      [258.906_25, -66.113_281_25],
      [249.898_437_5, -67.347_656_25],
      [238.847_656_25, -68.679_687_5],
      [229.199_218_75, -70.011_718_75],
      [219.660_156_25, -71.503_906_25],
      [209.109_375, -72.996_093_75],
      [197.144_531_25, -74.625],
      [186.527_343_75, -76.421_875],
      [176.667_968_75, -77.820_312_5],
      [167.269_531_25, -79.132_812_5],
      [159.574_218_75, -80.632_812_5],
      [152.75, -81.460_937_5],
      [146.460_937_5, -81.894_531_25],
      [139.972_656_25, -82.238_281_25],
      [133.546_875, -82.238_281_25],
      [127.847_656_25, -82.238_281_25],
      [123.019_531_25, -82.238_281_25],
      [117.9375, -81.914_062_5],
      [112.597_656_25, -81.046_875],
      [107.304_687_5, -79.902_343_75],
      [100.417_968_75, -78.457_031_25],
      [92.746_093_75, -76.878_906_25],
      [85.406_25, -75.359_375],
      [77.546_875, -73.808_593_75],
      [69.718_75, -72.664_062_5],
      [62.492_187_5, -71.960_937_5],
      [56.027_343_75, -71.230_468_75],
      [50.371_093_75, -70.261_718_75],
      [46.207_031_25, -69.324_218_75],
      [43.457_031_25, -68.480_468_75],
      [41.480_468_75, -67.570_312_5],
      [39.996_093_75, -66.902_343_75],
      [38.511_718_75, -66.238_281_25],
      [36.773_437_5, -65.367_187_5],
      [35.460_937_5, -64.359_375],
      [34.183_593_75, -63.328_125],
      [33.007_812_5, -62.542_968_75],
      [31.8125, -61.769_531_25],
      [30.523_437_5, -60.898_437_5],
      [29.492_187_5, -60.097_656_25],
      [28.507_812_5, -59.382_812_5],
      [27.246_093_75, -58.613_281_25],
      [25.496_093_75, -57.738_281_25],
      [23.742_187_5, -56.859_375],
      [21.996_093_75, -55.984_375],
      [20.519_531_25, -55.167_968_75],
      [19.492_187_5, -54.441_406_25],
      [18.816_406_25, -53.843_75],
      [18.355_468_75, -53.527_343_75],
      [18.085_937_5, -53.464_843_75],
      [17.855_468_75, -53.449_218_75],
      [17.855_468_75, -53.449_218_75],
    ] as LocalPoint[];

    updatePath(startPoint, points);

    const selectedElements = getSelectedElements(h.elements, h.state);
    expect(selectedElements.length).toBe(4);
    expect(selectedElements.filter((e) => e.type === "line").length).toBe(1);
    expect(selectedElements.filter((e) => e.type === "ellipse").length).toBe(1);
    expect(selectedElements.filter((e) => e.type === "diamond").length).toBe(1);
    expect(selectedElements.filter((e) => e.type === "freedraw").length).toBe(
      1,
    );
  });

  it("Single linear element", () => {
    const startPoint = pointFrom<GlobalPoint>(62, -200);
    const points = [
      [0, 0],
      [0, 0.101_562_5],
      [-1.656_25, 2.273_437_5],
      [-8.433_593_75, 12.265_625],
      [-17.578_125, 25.832_031_25],
      [-25.484_375, 37.386_718_75],
      [-31.453_125, 47.828_125],
      [-34.925_781_25, 55.218_75],
      [-37.117_187_5, 60.058_593_75],
      [-38.4375, 63.496_093_75],
      [-39.5, 66.632_812_5],
      [-40.574_218_75, 69.843_75],
      [-41.390_625, 73.535_156_25],
      [-41.929_687_5, 77.078_125],
      [-42.406_25, 79.714_843_75],
      [-42.667_968_75, 81.832_031_25],
      [-42.707_031_25, 83.324_218_75],
      [-42.707_031_25, 84.265_625],
      [-42.707_031_25, 85.171_875],
      [-42.707_031_25, 86.078_125],
      [-42.707_031_25, 86.648_437_5],
      [-42.707_031_25, 87],
      [-42.707_031_25, 87.179_687_5],
      [-42.707_031_25, 87.429_687_5],
      [-42.707_031_25, 87.832_031_25],
      [-42.707_031_25, 88.863_281_25],
      [-42.707_031_25, 91.277_343_75],
      [-42.707_031_25, 95.070_312_5],
      [-42.441_406_25, 98.468_75],
      [-42.175_781_25, 100.265_625],
      [-42.175_781_25, 101.160_156_25],
      [-42.160_156_25, 101.761_718_75],
      [-42.0625, 102.121_093_75],
      [-42.0625, 102.121_093_75],
    ] as LocalPoint[];
    updatePath(startPoint, points);

    const selectedElements = getSelectedElements(h.elements, h.state);
    expect(selectedElements.length).toBe(1);
    expect(h.app.state.selectedLinearElement).toBeDefined();
  });
});

describe("Special cases", () => {
  it("Select only frame if its children are also selected", () => {
    act(() => {
      const elements = [
        {
          id: "CaUA2mmuudojzY98_oVXo",
          type: "rectangle",
          x: -96.643_538_350_779_07,
          y: -270.160_058_574_112_9,
          width: 146.835_937_5,
          height: 104.921_875,
          angle: 0,
          strokeColor: "#1e1e1e",
          backgroundColor: "transparent",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          groupIds: [],
          frameId: "85VShCn1P9k81JqSeOg-c",
          index: "aE",
          roundness: {
            type: 3,
          },
          seed: 227_442_978,
          version: 15,
          versionNonce: 204_983_970,
          isDeleted: false,
          boundElements: [],
          updated: 1_740_959_550_684,
          link: null,
          locked: false,
        },
        {
          id: "RZzDDA1DBJHw5OzHVNDvc",
          type: "diamond",
          x: 126.649_430_399_220_93,
          y: -212.492_089_824_112_9,
          width: 102.558_593_75,
          height: 93.800_781_25,
          angle: 0,
          strokeColor: "#1e1e1e",
          backgroundColor: "transparent",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          groupIds: [],
          frameId: "85VShCn1P9k81JqSeOg-c",
          index: "aH",
          roundness: {
            type: 2,
          },
          seed: 955_233_890,
          version: 14,
          versionNonce: 2_135_303_358,
          isDeleted: false,
          boundElements: [],
          updated: 1_740_959_550_684,
          link: null,
          locked: false,
        },
        {
          id: "CSVDDbC9vxqgO2uDahcE9",
          type: "ellipse",
          x: -20.999_007_100_779_068,
          y: -87.027_246_074_112_9,
          width: 116.136_718_75,
          height: 70.773_437_5,
          angle: 0,
          strokeColor: "#1e1e1e",
          backgroundColor: "transparent",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          groupIds: [],
          frameId: "85VShCn1P9k81JqSeOg-c",
          index: "aI",
          roundness: {
            type: 2,
          },
          seed: 807_647_870,
          version: 16,
          versionNonce: 455_740_962,
          isDeleted: false,
          boundElements: [],
          updated: 1_740_959_550_684,
          link: null,
          locked: false,
        },
        {
          id: "85VShCn1P9k81JqSeOg-c",
          type: "frame",
          x: -164.956_038_350_779_07,
          y: -353.515_527_324_112_9,
          width: 451.042_968_75,
          height: 397.097_656_25,
          angle: 0,
          strokeColor: "#bbb",
          backgroundColor: "transparent",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 0,
          opacity: 100,
          groupIds: [],
          frameId: null,
          index: "aJ",
          roundness: null,
          seed: 1_134_892_578,
          version: 57,
          versionNonce: 1_699_466_238,
          isDeleted: false,
          boundElements: [],
          updated: 1_740_959_550_367,
          link: null,
          locked: false,
          name: null,
        },
      ].map((e) => ({
        ...e,
        index: null,
        angle: e.angle as Radians,
      })) as ExcalidrawElement[];

      h.elements = elements;
    });

    const startPoint = pointFrom<GlobalPoint>(-352, -64);
    const points = [
      [0, 0],
      [0.101_562_5, 0],
      [3.800_781_25, -1.058_593_75],
      [14.386_718_75, -5.105_468_75],
      [26.828_125, -10.707_031_25],
      [38.175_781_25, -16.105_468_75],
      [49.632_812_5, -21.593_75],
      [79.890_625, -34.078_125],
      [111.585_937_5, -46.414_062_5],
      [125.613_281_25, -51.265_625],
      [139.207_031_25, -55.816_406_25],
      [151.046_875, -60.277_343_75],
      [160.863_281_25, -64.140_625],
      [170.156_25, -67.511_718_75],
      [181.023_437_5, -71.523_437_5],
      [192.679_687_5, -75.792_968_75],
      [204.660_156_25, -80.199_218_75],
      [218.222_656_25, -85.6875],
      [233.359_375, -91.9375],
      [264.222_656_25, -103.917_968_75],
      [280.390_625, -109.808_593_75],
      [295.480_468_75, -114.996_093_75],
      [309.453_125, -120.281_25],
      [323.554_687_5, -126.125],
      [339.269_531_25, -132.679_687_5],
      [354.675_781_25, -139.644_531_25],
      [370.863_281_25, -146.531_25],
      [384.707_031_25, -152.492_187_5],
      [394.710_937_5, -157.679_687_5],
      [405.617_187_5, -163.074_218_75],
      [416.390_625, -167.964_843_75],
      [425.417_968_75, -171.648_437_5],
      [433.261_718_75, -174.785_156_25],
      [440.769_531_25, -177.683_593_75],
      [447.414_062_5, -179.718_75],
      [453.382_812_5, -181.113_281_25],
      [458.421_875, -182.136_718_75],
      [462.824_218_75, -182.554_687_5],
      [467.210_937_5, -182.640_625],
      [472.097_656_25, -182.640_625],
      [481.960_937_5, -182.640_625],
      [487.238_281_25, -182.585_937_5],
      [492.035_156_25, -181.917_968_75],
      [496.769_531_25, -180.640_625],
      [501.433_593_75, -179.273_437_5],
      [505.203_125, -177.730_468_75],
      [508.339_843_75, -176.089_843_75],
      [511.867_187_5, -174.167_968_75],
      [515.914_062_5, -172.093_75],
      [519.703_125, -170.125],
      [523.679_687_5, -167.882_812_5],
      [528.109_375, -165.398_437_5],
      [532.019_531_25, -163.3125],
      [535.281_25, -161.656_25],
      [537.628_906_25, -159.773_437_5],
      [539.085_937_5, -157.531_25],
      [540.164_062_5, -155.742_187_5],
      [540.980_468_75, -154.257_812_5],
      [541.878_906_25, -152.332_031_25],
      [542.691_406_25, -150.007_812_5],
      [543.253_906_25, -147.671_875],
      [543.906_25, -145.125],
      [544.667_968_75, -142.011_718_75],
      [545.343_75, -138.148_437_5],
      [546.035_156_25, -132.722_656_25],
      [546.410_156_25, -126.800_781_25],
      [546.449_218_75, -121.253_906_25],
      [546.386_718_75, -116.304_687_5],
      [545.214_843_75, -112],
      [541.503_906_25, -107.242_187_5],
      [536.515_625, -102.832_031_25],
      [531.441_406_25, -98.957_031_25],
      [526.394_531_25, -95.230_468_75],
      [521.152_343_75, -91.992_187_5],
      [514.386_718_75, -87.984_375],
      [506.953_125, -83.191_406_25],
      [499.117_187_5, -77.527_343_75],
      [491.371_093_75, -71.648_437_5],
      [484.855_468_75, -66.398_437_5],
      [477.820_312_5, -60.218_75],
      [469.921_875, -53.269_531_25],
      [460.847_656_25, -45.617_187_5],
      [451.796_875, -38.359_375],
      [444.339_843_75, -32.480_468_75],
      [438.429_687_5, -27.683_593_75],
      [435.210_937_5, -24.843_75],
      [433.074_218_75, -23.238_281_25],
      [429.742_187_5, -21.125],
      [424.898_437_5, -17.546_875],
      [418.742_187_5, -13.011_718_75],
      [411.843_75, -8.335_937_5],
      [404.800_781_25, -3.656_25],
      [398.238_281_25, 0.617_187_5],
      [392.324_218_75, 4.746_093_75],
      [386.218_75, 9.699_218_75],
      [379.742_187_5, 14.734_375],
      [373.601_562_5, 19.957_031_25],
      [367.343_75, 26.722_656_25],
      [360.738_281_25, 34.480_468_75],
      [354.148_437_5, 42.519_531_25],
      [347.214_843_75, 51.191_406_25],
      [340.597_656_25, 59.726_562_5],
      [334.468_75, 67.703_125],
      [328.992_187_5, 74.824_218_75],
      [323.785_156_25, 81.679_687_5],
      [318.664_062_5, 88.343_75],
      [314.210_937_5, 93.898_437_5],
      [309.105_468_75, 100.660_156_25],
      [304.175_781_25, 107.273_437_5],
      [299.972_656_25, 112.421_875],
      [295.890_625, 117.996_093_75],
      [291.882_812_5, 123.445_312_5],
      [288.007_812_5, 128.25],
      [284.917_968_75, 132.265_625],
      [282.453_125, 135.667_968_75],
      [279.800_781_25, 139.160_156_25],
      [276.773_437_5, 143.535_156_25],
      [274.351_562_5, 147.648_437_5],
      [272.085_937_5, 151.054_687_5],
      [269.554_687_5, 154.378_906_25],
      [267.714_843_75, 156.738_281_25],
      [266.628_906_25, 158.484_375],
      [265.554_687_5, 160.031_25],
      [264.738_281_25, 161.300_781_25],
      [264.160_156_25, 162.519_531_25],
      [263.464_843_75, 163.734_375],
      [262.914_062_5, 164.945_312_5],
      [262.050_781_25, 166.304_687_5],
      [261.234_375, 167.390_625],
      [260.464_843_75, 168.535_156_25],
      [259.570_312_5, 169.664_062_5],
      [258.929_687_5, 170.1875],
      [258.929_687_5, 170.1875],
    ] as LocalPoint[];

    updatePath(startPoint, points);

    const selectedElements = getSelectedElements(h.elements, h.state);
    expect(selectedElements.length).toBe(1);
    expect(selectedElements[0].type).toBe("frame");
  });

  it("Selects group if any group from group is selected", () => {
    act(() => {
      const elements = [
        {
          type: "line",
          version: 594,
          versionNonce: 1_548_428_815,
          isDeleted: false,
          id: "FBFkTIUB1trLc6nEdp1Pu",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 170.812_196_412_597_87,
          y: 391.165_999_387_685_5,
          strokeColor: "#1e1e1e",
          backgroundColor: "#846358",
          width: 66.164_065_513_082_79,
          height: 78.241_243_581_334_15,
          seed: 838_106_785,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          startBinding: null,
          endBinding: null,
          startArrowhead: null,
          endArrowhead: null,
          points: [
            [0, 0],
            [-12.922_669_045_523_984, 78.241_243_581_334_15],
            [53.241_396_467_558_81, 78.241_243_581_334_15],
            [41.352_540_945_676_74, 4.287_191_429_114_2],
            [0, 0],
          ],
          index: "aJ",
        },
        {
          type: "line",
          version: 947,
          versionNonce: 1_038_960_225,
          isDeleted: false,
          id: "RsALsOjcB5dAyH4JNlfqJ",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 188.531_192_640_216_03,
          y: 207.949_590_723_918_82,
          strokeColor: "#1e1e1e",
          backgroundColor: "#2f9e44",
          width: 369.231_284_652_655_8,
          height: 192.448_930_354_533_4,
          seed: 319_685_249,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          startBinding: null,
          endBinding: null,
          startArrowhead: null,
          endArrowhead: null,
          points: [
            [0, 0],
            [-184.827_182_629_488_7, 192.448_930_354_533_4],
            [184.404_102_023_167_1, 192.448_930_354_533_4],
            [0, 0],
          ],
          index: "aK",
        },
        {
          type: "line",
          version: 726,
          versionNonce: 1_463_389_231,
          isDeleted: false,
          id: "YNXwgpVIEUFgUZpJ564wo",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 184.667_260_711_623_67,
          y: 123.167_370_065_717_39,
          strokeColor: "#1e1e1e",
          backgroundColor: "#2f9e44",
          width: 290.965_323_016_053_5,
          height: 173.628_274_297_933_25,
          seed: 1_108_085_345,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          startBinding: null,
          endBinding: null,
          startArrowhead: null,
          endArrowhead: null,
          points: [
            [0, 0],
            [-142.346_302_724_233_74, 173.628_274_297_933_25],
            [148.619_020_291_819_74, 173.628_274_297_933_25],
            [0, 0],
          ],
          index: "aL",
        },
        {
          type: "line",
          version: 478,
          versionNonce: 2_081_935_937,
          isDeleted: false,
          id: "NV7XOz9ZIB8CbuqQIjt5k",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 189.055_651_217_414_44,
          y: 54.655_303_408_481_73,
          strokeColor: "#1e1e1e",
          backgroundColor: "#2f9e44",
          width: 194.196_753_378_859,
          height: 137.029_216_622_230_56,
          seed: 398_333_505,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          startBinding: null,
          endBinding: null,
          startArrowhead: null,
          endArrowhead: null,
          points: [
            [0, 0],
            [-97.031_691_387_691_5, 135.705_466_444_070_42],
            [97.165_061_991_167_5, 137.029_216_622_230_56],
            [0, 0],
          ],
          index: "aM",
        },
        {
          type: "ellipse",
          version: 282,
          versionNonce: 1_337_339_471,
          isDeleted: false,
          id: "b7FzLnG0L3-50bqij9mGX",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 73.903_692_482_667_4,
          y: 334.360_712_951_922_2,
          strokeColor: "#000000",
          backgroundColor: "#c2255c",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 654_550_561,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aN",
        },
        {
          type: "ellipse",
          version: 292,
          versionNonce: 1_355_145_761,
          isDeleted: false,
          id: "XzVfrVf3-sFJFPdOo51sb",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 138.211_563_919_380_35,
          y: 380.448_020_814_899_9,
          strokeColor: "#000000",
          backgroundColor: "#f08c00",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 2_060_204_545,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aO",
        },
        {
          type: "ellipse",
          version: 288,
          versionNonce: 1_889_111_151,
          isDeleted: false,
          id: "D4m0Ex4rPc1-8T-uv5vGh",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 208.950_222_499_764_6,
          y: 331.145_319_380_086_56,
          strokeColor: "#000000",
          backgroundColor: "#6741d9",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 337_072_609,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aP",
        },
        {
          type: "ellipse",
          version: 296,
          versionNonce: 686_224_897,
          isDeleted: false,
          id: "E0wxH4dAzQsv7Mj6OngC8",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 285.047_870_366_541_53,
          y: 367.586_446_527_557_3,
          strokeColor: "#000000",
          backgroundColor: "#e8590c",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 670_330_305,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aQ",
        },
        {
          type: "ellipse",
          version: 290,
          versionNonce: 1_974_216_335,
          isDeleted: false,
          id: "yKv_UI6iqa6zjVgYtXVcg",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 113.560_213_201_973_34,
          y: 228.252_725_081_345_77,
          strokeColor: "#000000",
          backgroundColor: "#228be6",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 495_127_969,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aR",
        },
        {
          type: "ellipse",
          version: 290,
          versionNonce: 662_343_137,
          isDeleted: false,
          id: "udyW842HtUTlqjDEOxoPN",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 166.078_308_208_622_8,
          y: 271.124_639_372_487_76,
          strokeColor: "#000000",
          backgroundColor: "#ffd43b",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 1_274_196_353,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aS",
        },
        {
          type: "ellipse",
          version: 300,
          versionNonce: 229_014_703,
          isDeleted: false,
          id: "R3VRfgkowIgnr5dFXwWXa",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 234.673_371_074_450_02,
          y: 237.898_905_796_852_72,
          strokeColor: "#000000",
          backgroundColor: "#38d9a9",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 2_021_841_249,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aT",
        },
        {
          type: "ellipse",
          version: 332,
          versionNonce: 1_670_392_257,
          isDeleted: false,
          id: "90W2w6zgGHdYda8UBiG2R",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 136.067_968_204_823_1,
          y: 155.370_470_786_404_35,
          strokeColor: "#000000",
          backgroundColor: "#fa5252",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 344_130_881,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aU",
        },
        {
          type: "ellipse",
          version: 337,
          versionNonce: 2_083_589_839,
          isDeleted: false,
          id: "nTDHvOk2mXLUFNn--7JvS",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 176.796_286_781_407_9,
          y: 102.852_375_779_755_42,
          strokeColor: "#000000",
          backgroundColor: "#9775fa",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 995_276_065,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aV",
        },
        {
          type: "ellipse",
          version: 313,
          versionNonce: 1_715_947_937,
          isDeleted: false,
          id: "iS2Q6cvQ5n_kxINfwu0HS",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 212.165_616_071_600_25,
          y: 153.226_875_071_847_27,
          strokeColor: "#000000",
          backgroundColor: "#fab005",
          width: 25.723_148_574_685_204,
          height: 25.723_148_574_685_204,
          seed: 1_885_432_065,
          groupIds: ["ts5VcKn3YXMmP8ipg8J5v", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: {
            type: 2,
          },
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          index: "aW",
        },
        {
          type: "line",
          version: 1590,
          versionNonce: 2_078_563_567,
          isDeleted: false,
          id: "X4-EPaJDEnPZKN1bWhFvs",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 158.196_164_694_678_43,
          y: 72.356_088_792_744_83,
          strokeColor: "#000000",
          backgroundColor: "#fab005",
          width: 84.291_019_259_825_15,
          height: 84.660_906_528_097_09,
          seed: 489_595_105,
          groupIds: ["uRBC-GT117eEzaf2ehdX_", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: null,
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          startBinding: null,
          endBinding: null,
          startArrowhead: null,
          endArrowhead: null,
          points: [
            [0, 0],
            [20.062_524_675_376_327, -6.158_183_070_239_938],
            [30.374_687_619_465_64, 12.304_817_735_352_257],
            [40.379_925_616_688_446, -6.146_146_743_410_616_5],
            [60.177_977_307_807_9, -0.291_961_089_827_182_33],
            [54.387_388_740_283_17, -19.998_927_589_317_724],
            [72.419_197_957_101_77, -30.209_920_701_755_497],
            [54.273_206_738_398_76, -40.520_131_959_038_096],
            [60.381_292_814_514_666, -60.139_916_640_513_16],
            [40.445_474_389_553_596, -54.210_585_495_743_58],
            [30.400_224_038_229_41, -72.356_088_792_744_83],
            [20.373_038_782_485_533, -54.221_076_193_873_93],
            [0.421_193_802_916_452_1, -59.964_664_015_244_09],
            [5.946_605_334_807_010_5, -39.940_204_997_734_04],
            [-11.871_821_302_723_378, -30.212_694_376_435_106],
            [5.916_318_974_536_789, -20.128_073_448_241_587],
            [0, 0],
          ],
          index: "aX",
        },
        {
          type: "line",
          version: 1719,
          versionNonce: 1_758_424_449,
          isDeleted: false,
          id: "MHWh6yM-hxZbKvIX473TA",
          fillStyle: "solid",
          strokeWidth: 2,
          strokeStyle: "solid",
          roughness: 1,
          opacity: 100,
          angle: 0,
          x: 166.459_589_050_943_63,
          y: 64.160_372_259_674_94,
          strokeColor: "#000000",
          backgroundColor: "#ffd43b",
          width: 61.283_169_868_033_82,
          height: 61.552_093_704_672_44,
          seed: 1_330_240_705,
          groupIds: ["uRBC-GT117eEzaf2ehdX_", "-9NzH7Fa5JaHu4ArEFpa_"],
          frameId: null,
          roundness: null,
          boundElements: [],
          updated: 1_740_960_278_015,
          link: null,
          locked: false,
          startBinding: null,
          endBinding: null,
          startArrowhead: null,
          endArrowhead: null,
          points: [
            [0, 0],
            [14.586_312_023_026_041, -4.477_262_020_152_575],
            [22.083_694_768_647_62, 8.946_127_856_709_843],
            [29.357_929_973_514_253, -4.468_511_096_647_962],
            [43.751_958_845_119_866, -0.212_268_177_794_634_7],
            [39.541_953_723_154_89, -14.540_074_226_137_776],
            [52.651_848_904_941_595, -21.963_902_184_629_42],
            [39.458_938_532_701_61, -29.459_865_970_613_833],
            [43.899_777_899_198_55, -43.724_287_114_968_824],
            [29.405_586_730_039_57, -39.413_410_215_631_98],
            [22.102_260_835_384_786, -52.605_965_847_962_594],
            [14.812_069_036_519_228, -39.421_037_401_080_7],
            [0.306_225_877_894_855_06, -43.596_870_973_860_4],
            [4.323_435_973_028_119, -29.038_234_309_343_977],
            [-8.631_320_963_092_225, -21.965_918_764_545_55],
            [4.301_416_496_013_572, -14.633_968_779_551_441],
            [0, 0],
          ],
          index: "aY",
        },
      ].map((e) => ({
        ...e,
        index: null,
        angle: e.angle as Radians,
      })) as ExcalidrawElement[];

      h.elements = elements;
    });

    const startPoint = pointFrom<GlobalPoint>(117, 463);
    const points = [
      [0, 0],
      [0.097_656_25, 0],
      [3.246_093_75, 0],
      [6.976_562_5, 0],
      [10.761_718_75, 0],
      [14.031_25, 0],
      [23.246_093_75, 0.324_218_75],
      [28.656_25, 0.648_437_5],
      [32.054_687_5, 0.648_437_5],
      [35.429_687_5, 0.648_437_5],
      [38.863_281_25, 0.382_812_5],
      [41.976_562_5, -0.109_375],
      [45.039_062_5, -0.429_687_5],
      [47.746_093_75, -0.523_437_5],
      [49.953_125, -0.730_468_75],
      [52.128_906_25, -0.9375],
      [54.25, -1.144_531_25],
      [55.992_187_5, -1.382_812_5],
      [57.675_781_25, -1.589_843_75],
      [58.8125, -1.769_531_25],
      [59.453_125, -1.769_531_25],
      [60.093_75, -1.769_531_25],
      [60.093_75, -1.769_531_25],
    ] as LocalPoint[];

    updatePath(startPoint, points);

    const selectedElements = getSelectedElements(h.elements, h.state);
    expect(selectedElements.length).toBe(16);
    expect(h.app.state.selectedGroupIds["-9NzH7Fa5JaHu4ArEFpa_"]).toBe(true);
  });
});
